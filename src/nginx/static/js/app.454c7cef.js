(function(e){function t(t){for(var n,o,i=t[0],c=t[1],u=t[2],d=0,f=[];d<i.length;d++)o=i[d],Object.prototype.hasOwnProperty.call(a,o)&&a[o]&&f.push(a[o][0]),a[o]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(e[n]=c[n]);l&&l(t);while(f.length)f.shift()();return r.push.apply(r,u||[]),s()}function s(){for(var e,t=0;t<r.length;t++){for(var s=r[t],n=!0,i=1;i<s.length;i++){var c=s[i];0!==a[c]&&(n=!1)}n&&(r.splice(t--,1),e=o(o.s=s[0]))}return e}var n={},a={app:0},r=[];function o(t){if(n[t])return n[t].exports;var s=n[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=n,o.d=function(e,t,s){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(s,n,function(t){return e[t]}.bind(null,n));return s},o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/";var i=window["webpackJsonp"]=window["webpackJsonp"]||[],c=i.push.bind(i);i.push=t,i=i.slice();for(var u=0;u<i.length;u++)t(i[u]);var l=c;r.push([0,"chunk-vendors"]),s()})({0:function(e,t,s){e.exports=s("56d7")},"034f":function(e,t,s){"use strict";var n=s("85ec"),a=s.n(n);a.a},"0d00":function(e,t,s){"use strict";var n=s("5833"),a=s.n(n);a.a},"56d7":function(e,t,s){"use strict";s.r(t);s("e260"),s("e6cf"),s("cca6"),s("a79d");var n=s("2b0e"),a=(s("7db0"),s("4160"),s("159b"),s("2f62")),r=(s("96cf"),s("1da1")),o=s("bc3a"),i=s.n(o),c=function(){var e=Object(r["a"])(regeneratorRuntime.mark((function e(t){var s,n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return s=l(t),e.next=3,i.a.get(s);case 3:return a=e.sent,n=a.data.status,console.log("GET: resultStatus: ",n),!0!==n&&console.log(a),e.abrupt("return",a.data);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),u=function(){var e=Object(r["a"])(regeneratorRuntime.mark((function e(t){var s,n,a,r=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return s=r.length>1&&void 0!==r[1]?r[1]:null,n=l(t),e.next=4,i.a.post(n,s);case 4:return a=e.sent,console.log("POST: resultStatus: ",a.data.status),!0!==a.data.status&&console.log("failed response: ",a),e.abrupt("return",a.data);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();function l(e){return"/api/v1/"+e}var d={get:c,post:u};n["default"].use(a["a"]);var f=1,m=2,h=new a["a"].Store({strict:!1,state:{user:{username:"",email:"",contacts:[],chats:[{chat_id:"",name:"",usernames:"",admin:"",messages:[]}]},allUsers:[],socket:{isConnected:!1,message:"",reconnectError:!1},newContactName:"",currentChatId:0},getters:{GET_USER:function(e){return e.user},GET_ALL_USERS:function(e){return e.allUsers},GET_MESSAGES:function(e){console.log("Message requested");var t=e.user.chats.find((function(t){return t.chat_id===e.currentChatId}));return void 0!==t?(console.log("Returning messages from store: ",t.messages),t.messages):null},GET_CURRENT_CHAT_ID:function(e){return e.currentChatId},GET_NEW_CONTACT_NAME:function(e){return e.newContactName}},mutations:{SET_USER:function(e,t){e.user.username=t.username,e.user.email=t.email,e.user.contacts=t.contacts,t.chats.forEach((function(e){e.messages=[]})),e.user.chats=t.chats,console.log("User set: ",e.user)},SET_ALL_USERS:function(e,t){e.allUsers=t},SET_CHAT_MESSAGES:function(e,t){e.user.chats.find((function(e){return e.chat_id===t.chat_id})).messages=t.messages},SOCKET_ONOPEN:function(e,t){n["default"].prototype.$socket=t.currentTarget,e.socket.isConnected=!0,console.log("Connected in store!")},SOCKET_ONCLOSE:function(e,t){e.socket.isConnected=!1},SOCKET_ONERROR:function(e,t){console.error("socket error in store: ",e,t)},SOCKET_ONMESSAGE:function(e,t){var s;switch(t.type){case f:s=e.user.chats.find((function(e){return e.chat_id===t.data.chat_id})),void 0!==s.messages&&null!==s.messages||(s.messages=[]),s.messages.push(t.data);break;case m:t.data.messages=[],e.user.chats.push(t.data);break;default:console.log("Unknown message type: ",t)}},SOCKET_RECONNECT:function(e,t){console.info(e,t)},SOCKET_RECONNECT_ERROR:function(e){e.socket.reconnectError=!0},SET_CURRENT_CHAT:function(e,t){e.currentChatId=t},SET_NEW_CONTACT_NAME:function(e,t){e.newContactName=t}},actions:{LOAD_USER_DATA:function(e){var t=d.get("user");t.then((function(t){var s=t.data;e.commit("SET_USER",s),s.chats.forEach((function(t){var s=d.get("messages/"+t.chat_id);s.then((function(s){var n=[];void 0!==s&&null!==s&&!1!==s.status?(s.data.forEach((function(e){n.push(e)})),e.commit("SET_CHAT_MESSAGES",{chat_id:t.chat_id,messages:n})):console.log("Some error in load messages")}))}))}))},LOAD_ALL_USERS:function(e){var t=d.get("all_users");t.then((function(t){e.commit("SET_ALL_USERS",t.data)}))},CHANGE_CURRENT_CHAT:function(e,t){e.commit("SET_CURRENT_CHAT",t)},CHANGE_NEW_CONTACT_NAME:function(e,t){e.commit("SET_NEW_CONTACT_NAME",t)},SEND_MESSAGE:function(e,t){var s={sender:e.getters.GET_USER.username,chat_id:e.getters.GET_CURRENT_CHAT_ID,is_read:!1,date:Date.now(),state:0,text:t,meta:null,attached_file_path:""};if(null===e.getters.GET_CURRENT_CHAT_ID){var a={name:e.getters.GET_USER.username+" with "+e.getters.GET_NEW_CONTACT_NAME,admin:e.getters.GET_USER.username,usernames:[e.getters.GET_USER.username,e.getters.GET_NEW_CONTACT_NAME]};d.post("chat",a).then((function(t){if(!1!==t.status){var a=t.data;console.log("Created chat: ",a),s.chat_id=a.chat_id,e.commit("SET_CURRENT_CHAT",a.chat_id),n["default"].prototype.$socket.send(JSON.stringify(s)),console.log("init message sent: ",s)}else console.log("server error creating chat")}))}else n["default"].prototype.$socket.send(JSON.stringify(s)),console.log("reg message sent: ",s)},RECEIVE_MESSAGE:function(e,t){e.commit("SOCKET_ONMESSAGE",t)}}}),p=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{attrs:{id:"app"}},[s("router-view")],1)},g=[],_={name:"App",components:{}},b=_,E=(s("034f"),s("2877")),v=Object(E["a"])(b,p,g,!1,null,null,null),C=v.exports,T=(s("f9e3"),s("2dd8"),s("8c4f")),S=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("b-container",{attrs:{fluid:""}},[s("b-alert",{attrs:{variant:"danger",dismissible:""},model:{value:e.showAlert,callback:function(t){e.showAlert=t},expression:"showAlert"}},[e._v(" "+e._s(e.alertText)+" ")]),s("b-row",{staticClass:"m-4 mt-5"},[s("b-col",[s("h1",[e._v("Welcome back")])])],1),s("b-row",{staticClass:"m-4"},[s("b-col",[s("label",[e._v(" Имя "),s("b-form-input",{attrs:{size:"lg",placeholder:"Enter your nick"},model:{value:e.user.username,callback:function(t){e.$set(e.user,"username",t)},expression:"user.username"}})],1)])],1),s("b-row",{staticClass:"m-4"},[s("b-col",[s("label",[e._v(" Пароль "),s("b-form-input",{attrs:{size:"lg",state:e.passwordOk,type:"password",placeholder:"Enter your password"},model:{value:e.user.password,callback:function(t){e.$set(e.user,"password",t)},expression:"user.password"}})],1)])],1),s("b-collapse",{staticClass:"mt-2",attrs:{id:"collapse-1"}},[s("b-row",{staticClass:"m-4"},[s("b-col",[s("label",[e._v(" Пароль еще раз "),s("b-form-input",{attrs:{size:"lg",state:e.passwordOk,type:"password",placeholder:"Enter password again"},model:{value:e.passwordVerif,callback:function(t){e.passwordVerif=t},expression:"passwordVerif"}})],1)])],1)],1),s("b-row",{staticClass:"m-4 mt-5"},[s("b-col",[s("b-button",{attrs:{variant:"success",size:"lg",block:e.isMobile},on:{click:function(t){e.isCreate?e.signUp():e.signIn()}}},[e._v(" "+e._s(e.isCreate?"Создать аккаут":"Войти")+" ")])],1)],1),s("b-row",[s("b-col",[s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.collapse-1",modifiers:{"collapse-1":!0}}],attrs:{variant:"outline-secondary"},on:{click:e.changeAction}},[e._v(" "+e._s(e.isCreate?"У меня есть аккаут":"У меня нет аккаутна")+" ")])],1)],1)],1)},w=[],A={name:"Login",data:function(){return{user:{username:"",password:""},passwordVerif:"",isCreate:!1,showAlert:!1,alertText:!1,isMobile:!0}},created:function(){this.isMobile=window.screen.width>500},methods:{signIn:function(){var e=this,t=this,s=d.post("signin",this.user);s.then((function(s){!0===s.status?t.$router.push("/chat"):(e.showAlert=!0,e.alertText="Имя и пароль не совпадают.")}))},signUp:function(){var e=this,t=this,s=d.post("signup",this.user);s.then((function(s){!0===s.status?t.$router.push("/chat"):(e.showAlert=!0,e.alertText="Не удалось создать аккаунт. Попробуйте позже.")}))},changeAction:function(){this.isCreate=!this.isCreate}},computed:{passwordOk:function(){return this.isCreate&&0!==this.user.password.length?this.user.password===this.passwordVerif:null}}},O=A,N=Object(E["a"])(O,S,w,!1,null,"247186ab",null),x=N.exports,y=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("b-container",[s("MobileSidebar",{attrs:{"user-data":e.user,"new-users":e.newUsers},on:{chat:function(t){return e.setExistingChat(t.data)},contact:function(t){return e.setNewChat(t.data)}}}),s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.sidebar-1",modifiers:{"sidebar-1":!0}}],staticClass:"position-fixed fixed-top",attrs:{squared:"",variant:"primary"}},[e._v("Меню")]),s("b-row",[s("b-col",[s("h4",[e._v("Чат "+e._s(e.chosenChat.usernames.join(", ")))])])],1),s("b-row",[s("b-col",[s("div",{staticClass:"messages-container",attrs:{id:"messages-cont"}},e._l(e.chosenChatMessages,(function(t){return s("div",{key:t.date,class:(t.sender===e.user.username?"right-message":"left-message")+" message-container"},[s("div",{staticClass:"message-header"},[s("div",{staticClass:"message-sender"},[e._v(" "+e._s(t.sender)+" ")]),s("div",{staticClass:"message-date"},[e._v(" "+e._s(e.convertToDatetime(t.date))+" ")])]),s("div",{staticClass:"message-text"},[e._v(e._s(t.text))])])})),0)])],1),s("b-row",{attrs:{"align-content":"center"}},[s("b-col",{attrs:{"align-self":"center"}},[s("div",{staticClass:"input-container w-75 m-auto"},[s("b-input-group",[s("b-input",{staticClass:"message-input",attrs:{placeholder:"Введите сообщение...",type:"text"},model:{value:e.messageText,callback:function(t){e.messageText=t},expression:"messageText"}}),s("b-input-group-append",[s("b-button",{attrs:{variant:"outline-primary"},on:{click:e.sendMessage}},[s("b-icon-envelope")],1)],1)],1)],1)])],1)],1)},R=[],U=(s("4de4"),s("caad"),s("2532"),function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("b-sidebar",{attrs:{id:"sidebar-1",title:"Chats",shadow:"",backdrop:""},scopedSlots:e._u([{key:"footer",fn:function(t){var n=t.hide;return[s("div",{staticClass:"d-flex bg-dark text-light justify-content-around align-items-center px-3 py-2"},[s("b-button",{attrs:{variant:"outline-warning"},on:{click:e.signOut}},[e._v("Выйти")]),s("b-button",{attrs:{size:"md"},on:{click:n}},[e._v("Закрыть")])],1)]}}]),model:{value:e.isOpened,callback:function(t){e.isOpened=t},expression:"isOpened"}},[s("b-container",[s("b-row",{staticClass:"m-3 mt-2"},[s("b-col",{attrs:{cols:"4"}},[s("b-avatar",{attrs:{variant:"primary",text:"BV"}})],1),s("b-col",{attrs:{cols:"6"}},[s("h3",[e._v(e._s(e.userData.username))])])],1),s("b-row",[s("b-col",{staticClass:"m-3"},[s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.all-chats-cont",modifiers:{"all-chats-cont":!0}}],staticClass:"mb-1",attrs:{variant:"info",block:""}},[e._v("Активные чаты")]),s("b-collapse",{attrs:{id:"all-chats-cont"}},[e.userData.chats.length>0?s("b-list-group",e._l(e.userData.chats,(function(t){return s("b-list-group-item",{key:t.chat_id,on:{click:function(s){return e.emitChat(t)}}},[e._v(" "+e._s(t.name)+" ")])})),1):s("p",[e._v("Чатов пока нет...")])],1)],1)],1),s("b-row",[s("b-col",{staticClass:"m-3"},[s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.all-users-cont",modifiers:{"all-users-cont":!0}}],staticClass:"mb-1",attrs:{variant:"info",block:""}},[e._v("Найти пользователя")]),s("b-collapse",{attrs:{id:"all-users-cont"}},[s("b-input",{attrs:{placeholder:"Поиск пользователей..."},model:{value:e.findUserText,callback:function(t){e.findUserText=t},expression:"findUserText"}}),e.newUsers.length>0?s("b-list-group",e._l(e.newUsers.filter((function(t){return t.username.includes(e.findUserText)>0})),(function(t){return s("b-list-group-item",{key:t.username,staticClass:"flex-row align-items-start",on:{click:function(s){return e.emitContact(t)}}},[s("div",{staticClass:"d-flex flex-row align-content-center justify-content-around"},[s("div",{staticClass:"align-self-lg-start"},[s("b-avatar")],1),s("div",[s("h4",[e._v(e._s(t.username))])])])])})),1):e._e()],1)],1)],1)],1)],1)}),k=[],G={name:"MobileSidebar",props:{userData:{type:Object,required:!0},newUsers:{type:Array,default:Array}},data:function(){return{findUserText:"",isOpened:!1}},methods:{emitChat:function(e){this.$emit("chat",{data:e}),this.isOpened=!1},emitContact:function(e){this.$emit("contact",{data:e}),this.isOpened=!1},signOut:function(){d.get("signout"),this.$router.push("/login")}}},M=G,$=Object(E["a"])(M,U,k,!1,null,"d0e331d6",null),L=$.exports,D={name:"Chat",components:{MobileSidebar:L},data:function(){return{chosenChat:{chat_id:null,name:"",usernames:[],admin:"",meta:0},messages:[],messageText:"",findUserText:"",showSidebar:!1}},created:function(){this.$store.dispatch("LOAD_USER_DATA"),this.$store.dispatch("LOAD_ALL_USERS"),this.connection=this.setConnection()},mounted:function(){var e=document.getElementById("messages-cont");e.scrollTop=e.scrollHeight},beforeDestroy:function(){this.$disconnect()},methods:{sendMessage:function(){this.$store.dispatch("SEND_MESSAGE",this.messageText),this.messageText=""},setConnection:function(){var e=this;this.$connect(),this.$options.sockets.onmessage=function(t){var s=JSON.parse(t.data);e.$store.dispatch("RECEIVE_MESSAGE",s);var n=document.getElementById("messages-cont");n.scrollTop=n.scrollHeight}},setExistingChat:function(e){this.chosenChat=e,this.chosenChat.meta=null,this.$store.dispatch("CHANGE_CURRENT_CHAT",e.chat_id)},setNewChat:function(e){this.chosenChat={chat_id:null,name:e.username,usernames:[e.username,this.user.username],admin:this.user.username,meta:e.username},this.messages=[],this.$store.dispatch("CHANGE_CURRENT_CHAT",null),this.$store.dispatch("CHANGE_NEW_CONTACT_NAME",e.username)},convertToDatetime:function(e){var t=new Date(e),s=t.getHours(),n="0"+t.getMinutes(),a="0"+t.getSeconds();return s+":"+n.substr(-2)+":"+a.substr(-2)}},computed:{user:function(){return this.$store.getters.GET_USER},allUsers:function(){return this.$store.getters.GET_ALL_USERS},newUsers:function(){var e=this;return this.$store.getters.GET_ALL_USERS.length<1?[]:this.$store.getters.GET_ALL_USERS.filter((function(t){return t.username!==e.user.username&&(null==e.user.contacts||!e.user.contacts.includes(t.username))}))},chosenChatMessages:function(){var e=document.getElementById("messages-cont");return null!==e&&(e.scrollTop=e.scrollHeight),this.$store.getters.GET_MESSAGES}}},H=D,j=(s("0d00"),Object(E["a"])(H,y,R,!1,null,"5054932b",null)),I=j.exports;n["default"].use(T["a"]);var P=[{path:"/",redirect:"/login"},{path:"/login",name:"login_page",meta:{title:"login page"},component:x},{path:"/chat",name:"chat_page",meta:{title:"Chat page"},component:I}],V=new T["a"]({mode:"history",base:"/",routes:P}),W=V,K=s("5f5b"),z=s("b1e0"),J=s("b408"),B=s.n(J);n["default"].use(B.a,"ws://"+window.location.host+"/ws/connect",{connectManually:!0,reconnection:!0,reconnectionAttempts:5},{store:h,protocol:"chat"}),n["default"].use(K["a"]),n["default"].use(z["a"]),n["default"].config.productionTip=!1,new n["default"]({store:h,router:W,render:function(e){return e(C)}}).$mount("#app")},5833:function(e,t,s){},"85ec":function(e,t,s){}});
//# sourceMappingURL=app.454c7cef.js.map