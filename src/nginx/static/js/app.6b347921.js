(function(t){function e(e){for(var n,o,i=e[0],c=e[1],u=e[2],d=0,h=[];d<i.length;d++)o=i[d],Object.prototype.hasOwnProperty.call(a,o)&&a[o]&&h.push(a[o][0]),a[o]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(t[n]=c[n]);l&&l(e);while(h.length)h.shift()();return r.push.apply(r,u||[]),s()}function s(){for(var t,e=0;e<r.length;e++){for(var s=r[e],n=!0,i=1;i<s.length;i++){var c=s[i];0!==a[c]&&(n=!1)}n&&(r.splice(e--,1),t=o(o.s=s[0]))}return t}var n={},a={app:0},r=[];function o(e){if(n[e])return n[e].exports;var s=n[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=t,o.c=n,o.d=function(t,e,s){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},o.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(s,n,function(e){return t[e]}.bind(null,n));return s},o.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/";var i=window["webpackJsonp"]=window["webpackJsonp"]||[],c=i.push.bind(i);i.push=e,i=i.slice();for(var u=0;u<i.length;u++)e(i[u]);var l=c;r.push([0,"chunk-vendors"]),s()})({0:function(t,e,s){t.exports=s("56d7")},"034f":function(t,e,s){"use strict";var n=s("85ec"),a=s.n(n);a.a},"56d7":function(t,e,s){"use strict";s.r(e);s("e260"),s("e6cf"),s("cca6"),s("a79d");var n=s("2b0e"),a=(s("7db0"),s("4160"),s("159b"),s("2f62")),r=(s("96cf"),s("1da1")),o=s("bc3a"),i=s.n(o),c=function(){var t=Object(r["a"])(regeneratorRuntime.mark((function t(e){var s,n,a;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return s=l(e),t.next=3,i.a.get(s);case 3:return a=t.sent,n=a.data.status,console.log("GET: resultStatus: ",n),!0!==n&&console.log(a),t.abrupt("return",a.data);case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),u=function(){var t=Object(r["a"])(regeneratorRuntime.mark((function t(e){var s,n,a,r=arguments;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return s=r.length>1&&void 0!==r[1]?r[1]:null,n=l(e),t.next=4,i.a.post(n,s);case 4:return a=t.sent,console.log("POST: resultStatus: ",a.data.status),!0!==a.data.status&&console.log("failed response: ",a),t.abrupt("return",a.data);case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();function l(t){return"/api/v1/"+t}var d={get:c,post:u};n["default"].use(a["a"]);var h=1,f=2,m=new a["a"].Store({strict:!1,state:{user:{username:"",email:"",contacts:[],chats:[{chat_id:"",name:"",usernames:"",admin:"",messages:[]}]},allUsers:[],socket:{isConnected:!1,message:"",reconnectError:!1},currentChatId:0},getters:{GET_USER:function(t){return t.user},GET_ALL_USERS:function(t){return t.allUsers},GET_MESSAGES:function(t){console.log("Message requested");var e=t.user.chats.find((function(e){return e.chat_id===t.currentChatId}));return void 0!==e?(console.log("Returning messages from store: ",e.messages),e.messages):null}},mutations:{SET_USER:function(t,e){t.user.username=e.username,t.user.email=e.email,t.user.contacts=e.contacts,e.chats.forEach((function(t){t.messages=[]})),t.user.chats=e.chats,console.log("User set: ",t.user)},SET_ALL_USERS:function(t,e){t.allUsers=e},SET_CHAT_MESSAGES:function(t,e){t.user.chats.find((function(t){return t.chat_id===e.chat_id})).messages=e.messages},SOCKET_ONOPEN:function(t,e){n["default"].prototype.$socket=e.currentTarget,t.socket.isConnected=!0,console.log("Connected in store!")},SOCKET_ONCLOSE:function(t,e){t.socket.isConnected=!1},SOCKET_ONERROR:function(t,e){console.error("socket error in store: ",t,e)},SOCKET_ONMESSAGE:function(t,e){switch(e.type){case h:t.user.chats.find((function(t){return t.chat_id===e.data.chat_id})).messages.push(e.data);break;case f:t.user.chats.push(e.data);break;default:console.log("Unknown message type: ",e)}},SOCKET_RECONNECT:function(t,e){console.info(t,e)},SOCKET_RECONNECT_ERROR:function(t){t.socket.reconnectError=!0},SET_CURRENT_CHAT:function(t,e){t.currentChatId=e}},actions:{LOAD_USER_DATA:function(t){var e=d.get("user");e.then((function(e){var s=e.data;t.commit("SET_USER",s),s.chats.forEach((function(e){var s=d.get("messages/"+e.chat_id);s.then((function(s){var n=[];void 0!==s&&null!==s&&!1!==s.status?(s.data.forEach((function(t){n.push(t)})),t.commit("SET_CHAT_MESSAGES",{chat_id:e.chat_id,messages:n})):console.log("Some error in load messages")}))}))}))},LOAD_ALL_USERS:function(t){var e=d.get("all_users");e.then((function(e){t.commit("SET_ALL_USERS",e.data)}))},CHANGE_CURRENT_CHAT:function(t,e){t.commit("SET_CURRENT_CHAT",e)},SEND_MESSAGE:function(t,e){n["default"].prototype.$socket.send(e)},RECEIVE_MESSAGE:function(t,e){t.commit("SOCKET_ONMESSAGE",e)}}}),p=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[s("router-view")],1)},g=[],b={name:"App",components:{}},_=b,v=(s("034f"),s("2877")),E=Object(v["a"])(_,p,g,!1,null,null,null),w=E.exports,C=(s("f9e3"),s("2dd8"),s("8c4f")),S=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("b-container",{attrs:{fluid:""}},[s("b-alert",{attrs:{variant:"danger",dismissible:""},model:{value:t.showAlert,callback:function(e){t.showAlert=e},expression:"showAlert"}},[t._v(" "+t._s(t.alertText)+" ")]),s("b-row",{staticClass:"m-4 mt-5"},[s("b-col",[s("h1",[t._v("Welcome back")])])],1),s("b-row",{staticClass:"m-4"},[s("b-col",[s("label",[t._v(" Имя "),s("b-form-input",{attrs:{size:"lg",placeholder:"Enter your nick"},model:{value:t.user.username,callback:function(e){t.$set(t.user,"username",e)},expression:"user.username"}})],1)])],1),s("b-row",{staticClass:"m-4"},[s("b-col",[s("label",[t._v(" Пароль "),s("b-form-input",{attrs:{size:"lg",state:t.passwordOk,type:"password",placeholder:"Enter your password"},model:{value:t.user.password,callback:function(e){t.$set(t.user,"password",e)},expression:"user.password"}})],1)])],1),s("b-collapse",{staticClass:"mt-2",attrs:{id:"collapse-1"}},[s("b-row",{staticClass:"m-4"},[s("b-col",[s("label",[t._v(" Пароль еще раз "),s("b-form-input",{attrs:{size:"lg",state:t.passwordOk,type:"password",placeholder:"Enter password again"},model:{value:t.passwordVerif,callback:function(e){t.passwordVerif=e},expression:"passwordVerif"}})],1)])],1)],1),s("b-row",{staticClass:"m-4 mt-5"},[s("b-col",[s("b-button",{attrs:{variant:"success",size:"lg",block:t.isMobile},on:{click:function(e){t.isCreate?t.signUp():t.signIn()}}},[t._v(" "+t._s(t.isCreate?"Создать аккаут":"Войти")+" ")])],1)],1),s("b-row",[s("b-col",[s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.collapse-1",modifiers:{"collapse-1":!0}}],attrs:{variant:"outline-secondary"},on:{click:t.changeAction}},[t._v(" "+t._s(t.isCreate?"У меня есть аккаут":"У меня нет аккаутна")+" ")])],1)],1)],1)},T=[],O={name:"Login",data:function(){return{user:{username:"",password:""},passwordVerif:"",isCreate:!1,showAlert:!1,alertText:!1,isMobile:!0}},created:function(){this.isMobile=window.screen.width>500},methods:{signIn:function(){var t=this,e=this,s=d.post("signin",this.user);s.then((function(s){!0===s.status?e.$router.push("/chat"):(t.showAlert=!0,t.alertText="Имя и пароль не совпадают.")}))},signUp:function(){var t=this,e=this,s=d.post("signup",this.user);s.then((function(s){!0===s.status?e.$router.push("/chat"):(t.showAlert=!0,t.alertText="Не удалось создать аккаунт. Попробуйте позже.")}))},changeAction:function(){this.isCreate=!this.isCreate}},computed:{passwordOk:function(){return this.isCreate&&0!==this.user.password.length?this.user.password===this.passwordVerif:null}}},x=O,y=Object(v["a"])(x,S,T,!1,null,"247186ab",null),A=y.exports,k=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("b-container",[s("MobileSidebar",{attrs:{"user-data":t.user,"new-users":t.newUsers},on:{chat:function(e){return t.setExistingChat(e.data)},contact:function(e){return t.setNewChat(e.data)}}}),s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.sidebar-1",modifiers:{"sidebar-1":!0}}],staticClass:"position-fixed fixed-top",attrs:{squared:"",variant:"primary"}},[t._v("Меню")]),s("b-row",[s("b-col",[s("h4",[t._v("Чат "+t._s(t.chosenChat.usernames.join(", ")))])])],1),s("b-row",[s("b-col",[s("div",{staticClass:"messages-container",attrs:{id:"messages-cont"}},t._l(t.chosenChatMessages,(function(e){return s("div",{key:e.date,class:(e.sender===t.user.username?"right-message":"left-message")+" message-container"},[s("div",{staticClass:"message-header"},[s("div",{staticClass:"message-sender"},[t._v(" "+t._s(e.sender)+" ")]),s("div",{staticClass:"message-date"},[t._v(" "+t._s(t.convertToDatetime(e.date))+" ")])]),s("div",{staticClass:"message-text"},[t._v(t._s(e.text))])])})),0)])],1),s("b-row",{attrs:{"align-content":"center"}},[s("b-col",{attrs:{"align-self":"center"}},[s("div",{staticClass:"input-container w-75 m-auto"},[s("b-input-group",[s("b-input",{staticClass:"message-input",attrs:{placeholder:"Введите сообщение...",type:"text"},model:{value:t.messageText,callback:function(e){t.messageText=e},expression:"messageText"}}),s("b-input-group-append",[s("b-button",{attrs:{variant:"outline-primary"},on:{click:t.sendMessage}},[s("b-icon-envelope")],1)],1)],1)],1)])],1)],1)},R=[],U=(s("4de4"),s("caad"),s("2532"),function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("b-sidebar",{attrs:{id:"sidebar-1",title:"Chats",shadow:"",backdrop:""},scopedSlots:t._u([{key:"footer",fn:function(e){var n=e.hide;return[s("div",{staticClass:"d-flex bg-dark text-light justify-content-around align-items-center px-3 py-2"},[s("b-button",{attrs:{variant:"outline-warning"},on:{click:t.signOut}},[t._v("Выйти")]),s("b-button",{attrs:{size:"md"},on:{click:n}},[t._v("Закрыть")])],1)]}}]),model:{value:t.isOpened,callback:function(e){t.isOpened=e},expression:"isOpened"}},[s("b-container",[s("b-row",{staticClass:"m-3 mt-2"},[s("b-col",{attrs:{cols:"4"}},[s("b-avatar",{attrs:{variant:"primary",text:"BV"}})],1),s("b-col",{attrs:{cols:"6"}},[s("h3",[t._v(t._s(t.userData.username))])])],1),s("b-row",[s("b-col",{staticClass:"m-3"},[s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.all-chats-cont",modifiers:{"all-chats-cont":!0}}],staticClass:"mb-1",attrs:{variant:"info",block:""}},[t._v("Активные чаты")]),s("b-collapse",{attrs:{id:"all-chats-cont"}},[t.userData.chats.length>0?s("b-list-group",t._l(t.userData.chats,(function(e){return s("b-list-group-item",{key:e.chat_id,on:{click:function(s){return t.emitChat(e)}}},[t._v(" "+t._s(e.name)+" ")])})),1):s("p",[t._v("Чатов пока нет...")])],1)],1)],1),s("b-row",[s("b-col",{staticClass:"m-3"},[s("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.all-users-cont",modifiers:{"all-users-cont":!0}}],staticClass:"mb-1",attrs:{variant:"info",block:""}},[t._v("Найти пользователя")]),s("b-collapse",{attrs:{id:"all-users-cont"}},[s("b-input",{attrs:{placeholder:"Поиск пользователей..."},model:{value:t.findUserText,callback:function(e){t.findUserText=e},expression:"findUserText"}}),t.newUsers.length>0?s("b-list-group",t._l(t.newUsers.filter((function(e){return e.username.includes(t.findUserText)>0})),(function(e){return s("b-list-group-item",{key:e.username,staticClass:"flex-row align-items-start",on:{click:function(s){return t.emitContact(e)}}},[s("div",{staticClass:"d-flex flex-row align-content-center justify-content-around"},[s("div",{staticClass:"align-self-lg-start"},[s("b-avatar")],1),s("div",[s("h4",[t._v(t._s(e.username))])])])])})),1):t._e()],1)],1)],1)],1)],1)}),M=[],$={name:"MobileSidebar",props:{userData:{type:Object,required:!0},newUsers:{type:Array,default:Array}},data:function(){return{findUserText:"",isOpened:!1}},methods:{emitChat:function(t){this.$emit("chat",{data:t}),this.isOpened=!1},emitContact:function(t){this.$emit("contact",{data:t}),this.isOpened=!1},signOut:function(){d.get("signout"),this.$router.push("/login")}}},N=$,L=Object(v["a"])(N,U,M,!1,null,"d0e331d6",null),G=L.exports,j={name:"Chat",components:{MobileSidebar:G},data:function(){return{chosenChat:{chat_id:null,name:"",usernames:[],admin:"",meta:0},messages:[],messageText:"",findUserText:"",showSidebar:!1}},created:function(){this.$store.dispatch("LOAD_USER_DATA"),this.$store.dispatch("LOAD_ALL_USERS"),this.connection=this.setConnection()},mounted:function(){var t=document.getElementById("messages-cont");t.scrollTop=t.scrollHeight},beforeDestroy:function(){this.$disconnect()},methods:{sendMessage:function(){var t={sender:this.user.username,chat_id:this.chosenChat.chat_id,meta:this.chosenChat.meta,date:Date.now(),state:0,text:this.messageText,attached_file_path:null};this.messageText="",this.$store.dispatch("SEND_MESSAGE",JSON.stringify(t))},setConnection:function(){var t=this;this.$connect(),this.$options.sockets.onmessage=function(e){var s=JSON.parse(e.data);t.$store.dispatch("RECEIVE_MESSAGE",s);var n=document.getElementById("messages-cont");n.scrollTop=n.scrollHeight}},setExistingChat:function(t){this.chosenChat=t,this.chosenChat.meta=0,this.$store.dispatch("CHANGE_CURRENT_CHAT",t.chat_id)},setNewChat:function(t){this.chosenChat={chat_id:t.username,name:t.username,usernames:[t.username,this.user.username],admin:this.user.username,meta:1},this.messages=[]},convertToDatetime:function(t){var e=new Date(t),s=e.getHours(),n="0"+e.getMinutes(),a="0"+e.getSeconds();return s+":"+n.substr(-2)+":"+a.substr(-2)}},computed:{user:function(){return this.$store.getters.GET_USER},allUsers:function(){return this.$store.getters.GET_ALL_USERS},newUsers:function(){var t=this;return this.$store.getters.GET_ALL_USERS.length<1?[]:this.$store.getters.GET_ALL_USERS.filter((function(e){return e.username!==t.user.username&&(null==t.user.contacts||!t.user.contacts.includes(e.username))}))},chosenChatMessages:function(){var t=document.getElementById("messages-cont");return null!==t&&(t.scrollTop=t.scrollHeight),this.$store.getters.GET_MESSAGES}}},D=j,H=(s("7cab"),Object(v["a"])(D,k,R,!1,null,"0397d522",null)),I=H.exports;n["default"].use(C["a"]);var P=[{path:"/",redirect:"/login"},{path:"/login",name:"login_page",meta:{title:"login page"},component:A},{path:"/chat",name:"chat_page",meta:{title:"Chat page"},component:I}],V=new C["a"]({mode:"history",base:"/",routes:P}),K=V,z=s("5f5b"),B=s("b1e0"),J=s("b408"),q=s.n(J);n["default"].use(q.a,"ws://"+window.location.host+"/ws/connect",{connectManually:!0,reconnection:!0,reconnectionAttempts:5},{store:m,protocol:"chat"}),n["default"].use(z["a"]),n["default"].use(B["a"]),n["default"].config.productionTip=!1,new n["default"]({store:m,router:K,render:function(t){return t(w)}}).$mount("#app")},"7cab":function(t,e,s){"use strict";var n=s("df4d"),a=s.n(n);a.a},"85ec":function(t,e,s){},df4d:function(t,e,s){}});
//# sourceMappingURL=app.6b347921.js.map